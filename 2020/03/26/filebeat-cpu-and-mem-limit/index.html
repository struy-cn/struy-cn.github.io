<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="分享编码、架构经验、效率工具、人工智能(AIGC) 、阅读感悟以及你感兴趣的知识荒原!"><meta name="keywords" content="AIGC,架构,云原生,效率工具,编程,编程入门,代码,学习,全栈,Spring,Java,Scala,老杨的知识荒原,StruggleYang,struy"><title>记Filebeat系统资源使用优化 | 老杨的知识荒原</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script src="https://www.googletagmanager.com/gtag/js?id=G-7HLMFGQR9B" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-7HLMFGQR9B');
</script><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?' + 'd2ed00d27f11374630ac0efc2332b027';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><div class="darkmode-toggle">🌓</div><script>var prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)');
var toggle = document.querySelector('.darkmode-toggle');
var html = document.querySelector('html');

html.dataset.dark = localStorage.dark || prefersDarkMode.matches;

toggle.addEventListener('click', () => {
localStorage.dark = !(html.dataset.dark == 'true');
html.dataset.dark = localStorage.dark;
});</script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">记Filebeat系统资源使用优化</h1><a id="logo" href="/.">老杨的知识荒原</a><p class="description">效率工具、编程技术、阅读感悟；你看到的世界就是你自己的样子！</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tools/"><i class="fa fa-coffee"> 工具箱</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">记Filebeat系统资源使用优化</h1><div class="post-meta">2020-03-26<span> | </span><span class="category"><a href="/categories/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></span><!-- 移动到footer.pug--><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%9C%BA%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">问题场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E7%89%88filebeat-yml%E9%85%8D%E7%BD%AE"><span class="toc-number">2.</span> <span class="toc-text">初版filebeat.yml配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E6%9C%9F%E7%9A%84%E9%97%AE%E9%A2%98%E5%92%8C%E8%B0%83%E6%95%B4"><span class="toc-number">3.</span> <span class="toc-text">初期的问题和调整:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%8F%8D%E5%A4%8D%E5%8F%8A%E4%B9%8B%E5%90%8E%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">问题反复及之后的处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%B8%80%EF%BC%9A%E9%99%8D%E4%BD%8E%E9%9D%9E%E9%A2%84%E6%9C%9F%E6%83%85%E5%86%B5%E4%B8%8B%E5%AF%B9%E5%BA%94%E7%94%A8%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">4.1.</span> <span class="toc-text">阶段一：降低非预期情况下对应用的影响</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B6%E6%AE%B5%E4%BA%8C%EF%BC%9A%E9%87%8D%E6%96%B0%E6%A2%B3%E7%90%86%E5%92%8C%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE%EF%BC%8C%E8%BE%BE%E5%88%B0%E4%BC%98%E5%8C%96%E5%86%85%E5%AD%98%E7%9A%84%E7%9B%AE%E7%9A%84"><span class="toc-number">4.2.</span> <span class="toc-text">阶段二：重新梳理和优化配置，达到优化内存的目的</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8cgroup%E9%99%90%E5%88%B6%E8%B5%84%E6%BA%90%E7%94%A8%E9%87%8F"><span class="toc-number">5.</span> <span class="toc-text">使用cgroup限制资源用量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8cgroup"><span class="toc-number">5.1.</span> <span class="toc-text">如何使用cgroup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E5%88%B0%E7%9A%84cgroup%E7%9A%84%E5%AD%90%E7%B3%BB%E7%BB%9F%EF%BC%9A"><span class="toc-number">5.2.</span> <span class="toc-text">用到的cgroup的子系统：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%90cgroup"><span class="toc-number">5.3.</span> <span class="toc-text">创建子cgroup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%89%8D%E4%BC%98%E5%8C%96%E5%90%8E%E7%9A%84%E5%AF%B9%E6%AF%94"><span class="toc-number">5.4.</span> <span class="toc-text">优化前优化后的对比</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><p>本文重点：<br>本文将着重关注filebeat，在filebeat在生产部署后，必定会对服务CPU、内存、网络有影响，如果将这些因素都在可控范围内，那是完全可以接受的。但是可能由于我们的配置不合理，或者非预期的情况导致CPU、内存占用过大，势必会影响到同在一起的业务应用稳定性。</p>
<span id="more"></span>

<blockquote>
<p>如今企业应用分布式、微服务盛行，针对分布于多节点的日志，会使用分布式日志系统架构，来满足业务开发查询多节点的日志并进行问题排查和定位。迄今为止，最为通用和成熟的就是elastic的ELK架构，我司现在也是按照如下通用架构(本文使用7.2版本的elastic套件)：</p>
<ul>
<li>filebeat(本文重点)：日志采集器，启动于业务服务器进行日志采集，并发送到kafka指定topic</li>
<li>kafka：大规模的企业应用通常会产生大量的日志，kafka可以为增长的日志削峰填谷</li>
<li>logstash:  将kafka的日志数据作为input，通过grok、oniguruma、mutate等过滤器将异构数据解析为结构化数据，最终存储到Elasticsearch</li>
<li>Elasticsearch：热门开源的搜索引擎，建立在 <a target="_blank" rel="noopener" href="https://lucene.apache.org/core/">Apache Lucene</a> 之上，在当前场景用于存储结构化的日志数据</li>
<li>kibana：用于检索和管理ES数据的UI界面</li>
</ul>
</blockquote>
<p>我们将在本文一步步介绍我们在使用过程中遇到的问题，配置的优化，如何确保filebeat部署在业务主机上对业务的影响降到最低，如何使用cgroup来限制filebeat的系统资源使用配额！</p>
<h3 id="问题场景"><a href="#问题场景" class="headerlink" title="问题场景"></a>问题场景</h3><p>有些文章说filebeat的内存消耗很少，不会超过100M，这是没有针对场景和没有经过测试不严谨的说法(刚开始我们也没有完全覆盖所有情况进行测试，当然部分偶然情况有时无法预知)，当真正按照默认的简单配置将filebeat部署到生产环境，或者某个参数配置错误，都可能会出现意想不到的问题，轻则影响服务的整体性能，重则可能造成应用被OOM-killer导致业务中断。我们在刚开始使用filebeat时，觉得这个组件已经如此成熟，应该问题不大。所以使用了最简单最基本的配置将其部署，为后来的问题埋下了祸根！</p>
<p>我们在实际使用中的确遇到了如下问题:</p>
<ul>
<li>Filebeat内存爆增至数GB、导致业务服务器触发OOM-killer，将业务进程kill掉</li>
<li>平常不会很频繁，但一旦压测或者有大量异常时就会出现以上问题</li>
</ul>
<p>来看几个问题样本:</p>
<p><img src="https://img.struy.cn/img/202304231520154.png" alt="oom"></p>
<blockquote>
<p>这里是filebeat导致Linux OOM 的一个场景，可使用 <code>dmesg -T</code> 查看，这里可以看到，在OOM时，filebeat大概占用523561*4k ～&#x3D; 2G(rss是内存页数,乘上内存页大小4k就是实际物理内存)(多的时候有过5G，比如有的日志文件中打印了很多二进制内容)</p>
</blockquote>
<p><img src="https://img.struy.cn/img/202304231521757.png"></p>
<blockquote>
<p>使用业务问题样本日志进行的测试的结果</p>
</blockquote>
<h3 id="初版filebeat-yml配置"><a href="#初版filebeat-yml配置" class="headerlink" title="初版filebeat.yml配置"></a>初版filebeat.yml配置</h3><p>这是初版的配置文件，相对简单，基本没有做什么特殊的配置:</p>
<blockquote>
<p>这是一个错误的样本配置，请不要使用</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#=========================== Filebeat inputs =============================</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span>                                <span class="comment"># 日志文件路径</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/data/logs/*/*.log</span></span><br><span class="line">  <span class="attr">exclude_files:</span> [<span class="string">.*file3.*|.*file4.*</span>]  <span class="comment"># 忽略的文件列表,正则匹配</span></span><br><span class="line">  <span class="attr">fields:</span>                               <span class="comment"># 在事件json中添加字段</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">$&#123;serviceName&#125;</span></span><br><span class="line">    <span class="attr">agentHost:</span> <span class="string">$&#123;hostIp&#125;</span></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">true</span>               <span class="comment"># 将添加的字段加在JSON的最外层</span></span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">false</span>                     <span class="comment"># 不建议一直开启,从日志文件的最后开始读取新内容</span></span><br><span class="line">  <span class="attr">multiline:</span>                            <span class="comment"># 多行匹配日志</span></span><br><span class="line">    <span class="attr">pattern:</span> <span class="string">&#x27;\[\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;&#x27;</span> <span class="comment"># 匹配一个以 [YYYY-MM-DD HH:mm:ss 开头的行</span></span><br><span class="line">    <span class="attr">negate:</span> <span class="literal">true</span>                        <span class="comment"># 将 pattern 取否(即不匹配pattern的情况)</span></span><br><span class="line">    <span class="attr">match:</span> <span class="string">after</span>                        <span class="comment"># 将其追加到上一行之后 pattern + negate + match 组合成一条语意为: 如果不匹配 [YYYY-MM-DD HH:mm:ss 开头的行，则将其合并到当前行的上一行</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">30s</span>                        </span><br><span class="line"></span><br><span class="line"><span class="comment">#=============================== Processors ===============================</span></span><br><span class="line"><span class="comment"># ...此处省略</span></span><br><span class="line"><span class="comment">#=============================== output ===============================</span></span><br><span class="line"><span class="attr">output.kafka:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&#x27;ip1:9092&#x27;</span>,<span class="string">&#x27;ip2:9092&#x27;</span>]</span><br><span class="line">  <span class="attr">topic:</span> <span class="string">&#x27;my_topic&#x27;</span></span><br><span class="line">  <span class="attr">partition.round_robin:</span></span><br><span class="line">    <span class="attr">reachable_only:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">worker:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">required_acks:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">compression:</span> <span class="string">gzip</span></span><br><span class="line">  <span class="attr">max_message_bytes:</span> <span class="number">1000000</span>            <span class="comment"># 10MB</span></span><br><span class="line"><span class="comment">#================================ Logging ======================================</span></span><br><span class="line"><span class="comment"># ...此处省略</span></span><br></pre></td></tr></table></figure>

<h3 id="初期的问题和调整"><a href="#初期的问题和调整" class="headerlink" title="初期的问题和调整:"></a>初期的问题和调整:</h3><p>我们接收业务反馈CPU占据到了300%上下(四核)，并且偶现开头出现的OOM现象。</p>
<p>经过文档的查阅，发现几个明显的配置问题，并针对其做过一次初步的优化</p>
<ol>
<li><code>max_bytes</code>：单行日志的大小，默认为10M</li>
<li><code>queue.mem.events</code>：内存队列的大小默认为4096，有这个一个公式 <code>max_bytes * queue.mem.events</code>等于约占的内存量，这里默认<code>10M * 4096=40G</code>,再考虑到队列存储已经编码为json的数据，则原始数据应该也会存储在内存中，那满打满算就得有80G内存占用，即使不存储原始日志，日常的服务器也难以接受这40G的内</li>
<li><code>max_procs</code>:没有限制CPU内核数使用，在日志较频繁时可能导致CPU满载</li>
<li><code>ignore_older</code>:由于服务器上有历史日志，可以使用此选项忽略较旧的文件</li>
</ol>
<p>初步调整:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">max_procs:</span> <span class="number">1</span>   <span class="comment"># *限制一个CPU核心,避免过多抢占业务资源</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">	  <span class="attr">ignore_older:</span> <span class="string">48h</span> <span class="comment"># 忽略这个时间之前的文件(根据文件改变时间)</span></span><br><span class="line">	  <span class="attr">max_bytes:</span> <span class="number">20480</span>  <span class="comment"># *单条日志的大小限制,将其从默认10M降低到20k，按照公式计算 20k * 4096 ～= 80M</span></span><br><span class="line">		<span class="comment"># ... 省略其他配置</span></span><br></pre></td></tr></table></figure>

<h3 id="问题反复及之后的处理"><a href="#问题反复及之后的处理" class="headerlink" title="问题反复及之后的处理"></a>问题反复及之后的处理</h3><p>上面的改动，以为已经控制住问题，但是在不久之后还是反复出现了多次同样的OOM问题</p>
<p>filebeat限制单条消息最大不能超过20k，默认内存队列存储4096条记录，再加上明文日志，最高内存理论最高值在  20k * 4096 * 2 &#x3D; 160M 左右浮动，即使做了以上限制，还是不时出现内存爆增的情况</p>
<p>一时没有找到问题解决方案，我们做了如下的几个阶段策略:</p>
<p>阶段一：降低非预期情况下对应用的影响</p>
<p>阶段二：重新梳理和优化配置，达到优化内存的目的</p>
<h4 id="阶段一：降低非预期情况下对应用的影响"><a href="#阶段一：降低非预期情况下对应用的影响" class="headerlink" title="阶段一：降低非预期情况下对应用的影响"></a>阶段一：降低非预期情况下对应用的影响</h4><p>降低非预期情况下对应用的影响，是将filebeat进程的oom_score_adj值设置为999，在出现意外情况时OOM也优先 kill 掉filebeat，从而达到即使出现意外情况，也不会影响到业务进程</p>
<p>具体的操作是：</p>
<p><code>启动filebeat -&gt; 获取进程PID -&gt; 写入/proc/$pid/oom_score_adj 为999</code></p>
<blockquote>
<p>OOM killer 机制一般情况下都会kill掉占用内存最大的进程，在kill进程时，有个算分的过程，这个算分过程是一个综合的过程，包括当前进程的占用内存情况，系统打分，还有可由用户控制的oom_score_adj分值，将影响整体算分。</p>
<p>oom_score_adj的取值范围是 -1000 至 1000，值越大，OOM在kill时会优先kill掉此进程，为了最大限度让系统kill掉filebeat，我们必须将此值调整到最大</p>
</blockquote>
<h4 id="阶段二：重新梳理和优化配置，达到优化内存的目的"><a href="#阶段二：重新梳理和优化配置，达到优化内存的目的" class="headerlink" title="阶段二：重新梳理和优化配置，达到优化内存的目的"></a>阶段二：重新梳理和优化配置，达到优化内存的目的</h4><p>针对多次问题的场景，进行样本的提取，发现多次问题出现的都是在大量的堆栈异常日志中出现，怀疑是多行合逻辑不对导致的问题：</p>
<p>下面我们来着重看一下多行最初配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">multiline:</span>                            <span class="comment"># 多行匹配日志</span></span><br><span class="line">   <span class="attr">pattern:</span> <span class="string">&#x27;\[\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;&#x27;</span> <span class="comment"># 匹配一个以 [YYYY-MM-DD HH:mm:ss 开头的行</span></span><br><span class="line">   <span class="attr">negate:</span> <span class="literal">true</span>                        <span class="comment"># 将 pattern 取否(即不匹配pattern的情况)</span></span><br><span class="line">   <span class="attr">match:</span> <span class="string">after</span>                        <span class="comment"># 将其追加到上一行之后 pattern + negate + match 组合成一条语意为: 如果不匹配 [YYYY-MM-DD HH:mm:ss 开头的行，则将其合并到当前行的上一行</span></span><br><span class="line">   <span class="attr">timeout:</span> <span class="string">30s</span>                        </span><br></pre></td></tr></table></figure>

<p>发现官网对于此参数的默认值是5s，但是现在却被误配置成了30s，肯定是有问题的啦</p>
<p><img src="https://img.struy.cn/img/202304231522881.png"></p>
<p>问题的原因应该就在 <code>multiline.timeout</code>这个参数之上，我们尝试调整多次参数的大小进行测试:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由于样本不同，可能内存量也会有所不同，这里选取的是在业务服务中有大量错误堆栈的日志进行测试</span></span><br><span class="line"><span class="comment"># 在其他参数不变的情况下测试</span></span><br><span class="line"><span class="attr">multiline.timeout:</span> <span class="string">30s</span> <span class="string">-&gt;</span>  <span class="string">10s</span>  <span class="string">-&gt;</span>   <span class="string">3s</span>  <span class="string">-&gt;</span>  <span class="string">2s</span>   <span class="string">-&gt;</span>   <span class="string">1s</span></span><br><span class="line">                   <span class="number">5.</span><span class="string">3G</span> <span class="string">-&gt;</span> <span class="number">4.</span><span class="string">8G</span> <span class="string">-&gt;</span> <span class="string">~2.5G</span> <span class="string">-&gt;</span> <span class="string">~730M</span>  <span class="string">-&gt;</span> <span class="string">~540M</span></span><br></pre></td></tr></table></figure>

<p>我的对官方的这句话的理解是:</p>
<blockquote>
<p>超时时间后,即使还未匹配到下一个多行事件，也将此次匹配的事件刷出</p>
</blockquote>
<p>如果日志中如果包含很多错误堆栈，或者不规范的日志大量匹配多行逻辑，会产生过多的多行合并任务，但是超时时间过长，过多的任务就会最大限度的匹配和在内存中等待，占用更多的内存！</p>
<p>除此以外我们也做了其他调整包括但不限于如下:</p>
<p><code>queue.mem.events</code>:从默认的4096 设置到了2048</p>
<p><code>queue.mem.flush.min_events</code>: 从默认2048设置到了1536</p>
<p><code>multiline.max_lines</code>:从默认500行设置到了200行</p>
<p>最后我们的最优配置如下，在调整之后将问题样本进行测试，内存只占用350M～500M之间：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#=========================== Filebeat inputs =============================</span></span><br><span class="line"><span class="attr">max_procs:</span> <span class="number">1</span>                            <span class="comment"># *限制一个CPU核心,避免过多抢占业务资源</span></span><br><span class="line"><span class="attr">queue.mem.events:</span> <span class="number">2048</span>                  <span class="comment"># 存储于内存队列的事件数，排队发送 (默认4096)</span></span><br><span class="line"><span class="attr">queue.mem.flush.min_events:</span> <span class="number">1536</span>        <span class="comment"># 小于 queue.mem.events ,增加此值可提高吞吐量 (默认值2048)</span></span><br><span class="line"><span class="comment">#queue.mem.flush.timeout: 1s             # 这是一个默认值，到达 min_events 需等待多久刷出</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="string">48h</span>                     <span class="comment"># 忽略这个时间之前的文件(根据文件改变时间)</span></span><br><span class="line">  <span class="attr">max_bytes:</span> <span class="number">20480</span>                      <span class="comment"># *单条日志的大小限制,建议限制(默认为10M,queue.mem.events * max_bytes 将是占有内存的一部分)</span></span><br><span class="line">  <span class="attr">recursive_glob.enabled:</span> <span class="literal">true</span>          <span class="comment"># 是否启用glob匹配,可匹配多级路径(最大8级)：/A/**/*.log =&gt; /A/*.log ~ /A/**/**/**/**/**/**/**/**/*.log  </span></span><br><span class="line">  <span class="attr">paths:</span>                                <span class="comment"># 日志文件路径</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/data/logs/**/*.log</span></span><br><span class="line">  <span class="attr">exclude_files:</span> [<span class="string">.*file1.*|stdout.log|.*file2.*</span>] <span class="comment"># 忽略的文件列表,正则匹配</span></span><br><span class="line">  <span class="attr">fields:</span>                               <span class="comment"># 在事件json中添加字段</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">$&#123;serviceName&#125;</span></span><br><span class="line">    <span class="attr">agentHost:</span> <span class="string">$&#123;hostIp&#125;</span></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">true</span>               <span class="comment"># 将添加的字段加在JSON的最外层</span></span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">false</span>                     <span class="comment"># 不建议一直开启,从日志文件的最后开始读取新内容(保证读取最新文件),但是如果有日志轮转，可能导致文件内容丢失，建议结合 ignore_older 将其设置为false</span></span><br><span class="line">  <span class="attr">multiline:</span>                            <span class="comment"># 多行匹配日志 (https://www.elastic.co/guide/en/beats/filebeat/7.2/multiline-examples.html)</span></span><br><span class="line">    <span class="attr">pattern:</span> <span class="string">&#x27;\[\d&#123;4&#125;-\d&#123;2&#125;-\d&#123;2&#125; \d&#123;2&#125;:\d&#123;2&#125;:\d&#123;2&#125;&#x27;</span> <span class="comment"># 匹配一个以 [YYYY-MM-DD HH:mm:ss 开头的行</span></span><br><span class="line">    <span class="attr">negate:</span> <span class="literal">true</span>                        <span class="comment"># 将 pattern 取否(即不匹配pattern的情况)</span></span><br><span class="line">    <span class="attr">match:</span> <span class="string">after</span>                        <span class="comment"># 将其追加到上一行之后 pattern + negate + match 组合成一条语意为: 如果不匹配 [YYYY-MM-DD HH:mm:ss 开头的行，则将其合并到当前行的上一行</span></span><br><span class="line">    <span class="attr">max_lines:</span> <span class="number">200</span>                      <span class="comment"># 最多匹配多少行，如果超出最大行数，则丢弃多余的行(默认500)</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">1s</span>                         <span class="comment"># 超时时间后,即使还未匹配到下一个行日志(下一个多行事件)，也将此次匹配的事件刷出 (默认5s)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#=============================== Processors ===============================</span></span><br><span class="line"><span class="comment"># 省略</span></span><br><span class="line"><span class="comment">#=============================== output ===============================</span></span><br><span class="line"><span class="attr">output.kafka:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&#x27;ip1:9092&#x27;</span>,<span class="string">&#x27;ip2:9092&#x27;</span>]</span><br><span class="line">  <span class="attr">topic:</span> <span class="string">&#x27;my_topic&#x27;</span></span><br><span class="line">  <span class="attr">partition.round_robin:</span></span><br><span class="line">    <span class="attr">reachable_only:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">worker:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">required_acks:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">compression:</span> <span class="string">gzip</span></span><br><span class="line">  <span class="attr">max_message_bytes:</span> <span class="number">1000000</span>            <span class="comment"># 10MB</span></span><br><span class="line"><span class="comment">#================================ Logging ======================================</span></span><br><span class="line"><span class="comment"># 省略</span></span><br></pre></td></tr></table></figure>

<h3 id="使用cgroup限制资源用量"><a href="#使用cgroup限制资源用量" class="headerlink" title="使用cgroup限制资源用量"></a>使用cgroup限制资源用量</h3><p>对于我们的业务机器来说，让filebeat独占一个CPU去进行日志收集，显然不被业务人员所接受，因为在业务高峰期日志量会很大，filebaat进行大吞吐量的日志收集、多行合并、消息发送；很有可能会限制业务的性能，可能没有filebeat我原本需要10台主机，但是有了filebeat我就需要15台主机来承载高峰业务。</p>
<p>上面的配置虽然已经基本控制住内存用量，但也有可能出现不同的不可预期的情况导致内存增长</p>
<p>我们该如何限制CPU使用量和应对意想不到的内存增长情况？</p>
<p>答案是：绝对性的控制CPU&#x2F;内存在一个范围内，我们可以使用cgroup来实现</p>
<p>什么是cgroup？</p>
<blockquote>
<p>cgroups 是Linux内核提供的一种可以限制单个进程或者多个进程所使用资源的机制，可以对 cpu，内存等资源实现精细化的控制，容器 Docker 技术就使用了 cgroups 提供的资源限制能力来完成cpu，内存等部分的资源控制。</p>
<p>另外，开发者也可以使用cgroup提供的精细化的控制能力，来限制某一组&#x2F;一个进程的资源使用，比如我们的日志agent需要部署到应用服务器，为了保证系统稳定性，可以限制agent的资源用量在合理范围。</p>
<p>由于篇幅限制，这里对cgroup就不多做介绍了，只说如何使用起来，如果有不明白的，可以查看下方参考链接</p>
</blockquote>
<h4 id="如何使用cgroup"><a href="#如何使用cgroup" class="headerlink" title="如何使用cgroup"></a>如何使用cgroup</h4><p>cgroup相关的所有操作都是基于内核中的cgroup virtual filesystem，使用cgroup很简单，挂载这个文件系统即可。一般情况默认已经挂载到<code>/sys/fs/cgroup</code>目录下了</p>
<p><code>mount | grep cgroup</code> 查看系统默认是否挂载cgroup，cgroup包含很多子系统，用来控制进程不同的资源使用，我们只用其中cpu和memory这两个</p>
<p><img src="https://img.struy.cn/img/202304231523898.png"></p>
<h4 id="用到的cgroup的子系统："><a href="#用到的cgroup的子系统：" class="headerlink" title="用到的cgroup的子系统："></a>用到的cgroup的子系统：</h4><ol>
<li>cpu 子系统，主要限制进程的 cpu 使用率</li>
<li>memory 子系统，可以限制进程的 memory 使用量</li>
</ol>
<h4 id="创建子cgroup"><a href="#创建子cgroup" class="headerlink" title="创建子cgroup"></a>创建子cgroup</h4><ul>
<li>如果需要限制cpu，则在已挂载的 <code>/sys/fs/cgroup/cpu</code> 子系统下建立任意目录，如<code>filebeat_cpu</code></li>
<li>如果需要限制内存，则在已挂载的 <code>/sys/fs/cgroup/memory</code> 子系统下建立任意目录，如<code>filebeat_memory</code></li>
</ul>
<p>filebeat_cpu和filebeat_memory下都会自动生成与上级目录相同的文件，我们重点关注一下几个文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">filebeat_cpu</span><br><span class="line">	- cgroup.procs	      <span class="comment"># 限制的进程pid		</span></span><br><span class="line">	- cpu.cfs_period_us   <span class="comment"># 用来配置时间周期长度	(us)</span></span><br><span class="line">	- cpu.cfs_quota_us    <span class="comment"># 用来配置当前cgroup在设置的周期长度内所能使用的CPU时间数(us)</span></span><br><span class="line">	</span><br><span class="line"><span class="comment"># cpu.cfs_period_us&amp;cpu.cfs_quota_us 两个文件配合起来设置CPU的使用上限</span></span><br><span class="line"><span class="comment"># cfs_period_us的取值范围为1毫秒（ms）到1秒（s），cfs_quota_us的取值大于1ms即可</span></span><br><span class="line"><span class="comment"># 如果cfs_quota_us的值为-1（默认值），表示不受cpu时间的限制</span></span><br><span class="line"><span class="comment"># 如限制使用1个CPU的25%（每40ms能使用10ms的CPU时间，即使用一个CPU核心的25%)</span></span><br><span class="line"><span class="comment"># 则echo 40000 &gt; cpu.cfs_period_us &amp;&amp; echo 40000 &gt; cpu.cfs_quota_us</span></span><br><span class="line"></span><br><span class="line">filebeat_memory</span><br><span class="line">	- cgroup.procs			  <span class="comment"># 限制的进程pid</span></span><br><span class="line">	- memory.limit_in_bytes   <span class="comment"># 限制的内存大小</span></span><br><span class="line">	- memory.oom_control     </span><br><span class="line"></span><br><span class="line"><span class="comment"># memory.oom_control</span></span><br><span class="line"><span class="comment"># 0:将启动OOM-killer，当内核无法给进程分配足够的内存时，将会直接kill掉该进程</span></span><br><span class="line"><span class="comment"># 1:表示不启动OOM-killer，当内核无法给进程分配足够的内存时，将会暂停该进程直到有空余的内存之后再继续运行；</span></span><br><span class="line"><span class="comment"># 同时，memory.oom_control还包含一个只读的under_oom字段，用来表示当前是否已经进入oom状态，也即是否有进程被暂停了。</span></span><br></pre></td></tr></table></figure>

<p>改造我们的filebeat启动脚本,支持在启动后限制内存和cpu:</p>
<blockquote>
<p>restartFilebeat.sh</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># @metainfo: filebeat 启动脚本</span></span><br><span class="line"><span class="comment"># @author: struy</span></span><br><span class="line"><span class="comment"># 1.设置filebeat需要的主机和应用信息，详情见filebeat.yml</span></span><br><span class="line"><span class="comment"># 2.设置针对filebeat CPU、内存的 cgroup 限额: CPU -&gt; 单核25%，内存 -&gt; 500M </span></span><br><span class="line"><span class="comment"># 3.停止旧进程，检查环境变量，重启filebeat</span></span><br><span class="line"><span class="comment"># 4.写入filebeat进程oom_score_adj值(999),写入进程号至为filebeat准备的cgroup.procs中</span></span><br><span class="line"><span class="comment"># 5.review 配置信息</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================variable============================= #</span></span><br><span class="line">_hostIp=`ifconfig eth0|grep <span class="string">&quot;inet &quot;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line">_serviceName=(`ps -ef |grep -Ev <span class="string">&#x27;grep&#x27;</span> | grep -Eo <span class="string">&#x27;applicationName=.*? &#x27;</span> | awk <span class="string">&#x27;&#123;print  $1&#125;&#x27;</span> | awk -F = <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`)</span><br><span class="line"></span><br><span class="line">filebeat_oom_score_adj=999  			<span class="comment"># OOM时,将优先OOM掉filebeat,虽然现在占用不大，为避免特殊情况影响业务</span></span><br><span class="line">filebeat_memory_limit_mb=500M     <span class="comment"># 内存限额</span></span><br><span class="line">filebeat_single_cpu_scale=0.25 		<span class="comment"># 占单个cpu的比例</span></span><br><span class="line">filebeat_cfs_period_us=40000			<span class="comment"># CPU的时间周期</span></span><br><span class="line">filebeat_cfs_quota_us=`<span class="built_in">echo</span> <span class="variable">$filebeat_single_cpu_scale</span> <span class="variable">$filebeat_cfs_period_us</span> | awk <span class="string">&#x27;&#123;printf &quot;%0.0f\n&quot; ,$1*$2&#125;&#x27;</span>`  			<span class="comment"># 周期内的限额 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================== ENV ============================= #</span></span><br><span class="line"><span class="built_in">export</span> hostIp=<span class="variable">$_hostIp</span></span><br><span class="line"><span class="built_in">export</span> serviceName=<span class="variable">$_serviceName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================== cgroup check and setting ============================= #</span></span><br><span class="line"><span class="keyword">if</span> [[ -d <span class="string">&quot;/sys/fs/cgroup/cpu/filebeat_cpu&quot;</span> ]] &amp;&amp; [[ -d <span class="string">&quot;/sys/fs/cgroup/memory/filebeat_memory&quot;</span> ]];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&#x27;cgroup [filebeat_cpu、filebeat_memory] is exist&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&#x27;cgroup [filebeat_cpu、filebeat_memory] is not exist , now mkdir and setting quota&#x27;</span></span><br><span class="line">	<span class="comment"># CPU</span></span><br><span class="line">	<span class="built_in">mkdir</span> /sys/fs/cgroup/cpu/filebeat_cpu</span><br><span class="line">	<span class="comment"># 内存</span></span><br><span class="line">	<span class="built_in">mkdir</span> /sys/fs/cgroup/memory/filebeat_memory</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cfs_period_us用来配置时间周期长度</span></span><br><span class="line"><span class="comment"># cfs_quota_us用来配置当前cgroup在设置的周期长度内所能使用的CPU时间数</span></span><br><span class="line"><span class="comment"># 两个文件配合起来设置CPU的使用上限。两个文件的单位都是微秒（us），</span></span><br><span class="line"><span class="comment"># cfs_period_us的取值范围为1毫秒（ms）到1秒（s），cfs_quota_us的取值大于1ms即可</span></span><br><span class="line"><span class="comment"># 如果cfs_quota_us的值为-1（默认值），表示不受cpu时间的限制</span></span><br><span class="line"><span class="comment"># 限制使用1个CPU的25%（每40ms能使用10ms的CPU时间，即使用一个CPU核心的25%）</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$filebeat_cfs_period_us</span> &gt; /sys/fs/cgroup/cpu/filebeat_cpu/cpu.cfs_period_us</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$filebeat_cfs_quota_us</span> &gt; /sys/fs/cgroup/cpu/filebeat_cpu/cpu.cfs_quota_us</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内存限制小于 400M,写入自动转换为bytes</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$filebeat_memory_limit_mb</span> &gt; /sys/fs/cgroup/memory/filebeat_memory/memory.limit_in_bytes</span><br><span class="line"><span class="comment"># 0:即使系统有交换空间，也不使用交换空间</span></span><br><span class="line"><span class="comment">#echo 0 &gt; /sys/fs/cgroup/memory/filebeat_memory/memory.swappiness</span></span><br><span class="line"><span class="comment"># 0:OOM-killer 1:暂停进程等有可用内存再继续运行</span></span><br><span class="line"><span class="comment">#echo 0 &gt; /sys/fs/cgroup/memory/filebeat_memory/memory.oom_control</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==========================kill old============================= #</span></span><br><span class="line">oldPid=(`ps -ef|grep <span class="string">&#x27;agent7.2/filebeat-7.2.0-linux-x86_64/filebeat&#x27;</span> |grep -v <span class="string">&#x27;grep&#x27;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`)</span><br><span class="line"><span class="keyword">if</span> [[ ! <span class="variable">$oldPid</span> ]]; <span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;filebeat agent not runing,now run!&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;oldPid =&gt; [<span class="variable">$&#123;oldPid[*]&#125;</span>],kill now&quot;</span></span><br><span class="line">	<span class="built_in">kill</span> <span class="variable">$&#123;oldPid[*]&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 1s</span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================== check ENV and run ============================= #</span></span><br><span class="line"><span class="keyword">if</span> [[ ! <span class="variable">$hostIp</span> ]]||[[ ! <span class="variable">$serviceName</span> ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;env [hostIp] or [serviceName] is not set, cancel start!&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$&#123;#serviceName[*]&#125;</span> -ne 1 ]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;env [serviceName] more than one:serviceName =&gt; [<span class="variable">$&#123;serviceName[*]&#125;</span>],cancel start!&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">   <span class="built_in">nohup</span> /data/agent7.2/filebeat-7.2.0-linux-x86_64/filebeat run -e -c /data/agent7.2/filebeat-7.2.0-linux-x86_64/filebeat.yml  &gt;&gt; /data/agent7.2/nohup.out 2&gt;&amp;1 &amp;</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># !!! 确保已经在运行,延时可能在cgroup未生效的情况下应用内存就增长了，但是不会超过限制内存的20%</span></span><br><span class="line"><span class="built_in">sleep</span> 1s</span><br><span class="line"></span><br><span class="line">pid=(`ps -ef|grep <span class="string">&#x27;agent7.2/filebeat-7.2.0-linux-x86_64/filebeat&#x27;</span> |grep -v <span class="string">&#x27;grep&#x27;</span>|awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ ! <span class="variable">$pid</span> ]];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">&quot;filebeat not runing,cgroup no check&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="comment"># ========================== setting oom_socre_adj ============================= #</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$filebeat_oom_score_adj</span> &gt; /proc/<span class="variable">$pid</span>/oom_score_adj</span><br><span class="line">	<span class="comment"># ========================== setting filebeat cgroup procs ============================= #</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$pid</span> &gt; /sys/fs/cgroup/cpu/filebeat_cpu/cgroup.procs</span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$pid</span> &gt; /sys/fs/cgroup/memory/filebeat_memory/cgroup.procs</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ========================== review setting ============================= #</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;pid-&gt;<span class="variable">$pid</span> hostName-&gt;<span class="variable">$HOSTNAME</span> hostIp-&gt;<span class="variable">$hostIp</span> appName-&gt;<span class="variable">$serviceName</span>&quot;</span> \</span><br><span class="line"><span class="string">&quot;filebeat_oom_score_adj-&gt;&quot;</span>`<span class="built_in">cat</span> /proc/<span class="variable">$pid</span>/oom_score` \</span><br><span class="line"><span class="string">&quot;filebeat_cpu/cpu.cfs_period_us-&gt;&quot;</span>`<span class="built_in">cat</span> /sys/fs/cgroup/cpu/filebeat_cpu/cpu.cfs_period_us` \</span><br><span class="line"><span class="string">&quot;filebeat_cpu/cpu.cfs_quota_us-&gt;&quot;</span>`<span class="built_in">cat</span> /sys/fs/cgroup/cpu/filebeat_cpu/cpu.cfs_quota_us` \</span><br><span class="line"><span class="string">&quot;filebeat_memory/memory.limit_in_bytes-&gt;&quot;</span>`<span class="built_in">cat</span> /sys/fs/cgroup/memory/filebeat_memory/memory.limit_in_bytes`</span><br></pre></td></tr></table></figure>

<p>限制:</p>
<p>CPU -&gt; 单核25%</p>
<p>内存 -&gt; 500M,大于此值则触发cgroup的OOM-killer机制</p>
<h4 id="优化前优化后的对比"><a href="#优化前优化后的对比" class="headerlink" title="优化前优化后的对比"></a>优化前优化后的对比</h4><p>优化前：</p>
<p><img src="https://img.struy.cn/img/202304231524441.png"></p>
<p>优化后:</p>
<p><img src="https://img.struy.cn/img/202304231524254.png"></p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/7.2/configuring-howto-filebeat.html">Filebeat 官网配置文档</a></li>
<li><a target="_blank" rel="noopener" href="http://www.wowotech.net/memory_management/oom.html">OOM相关参数</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000006917884">Linux cgroup 概述</a></li>
</ul>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css?v=1.0.0"><p><span>本文标题：</span>记Filebeat系统资源使用优化</p><p><span>文章作者：</span>StruggleYang</p><p><span>发布时间：</span>2020-03-26</p><p><span>最后更新：</span>2023-04-25</p><p><span>原始链接：</span><a href="/2020/03/26/filebeat-cpu-and-mem-limit/">https://struy.cn/2020/03/26/filebeat-cpu-and-mem-limit/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://struy.cn/2020/03/26/filebeat-cpu-and-mem-limit/"></i></span></p><p><span>版权声明：</span>未经允许禁止转载，请关注公众号联系作者</p></div><br><div class="tags"><ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ELK/" rel="tag">ELK</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Filebeat/" rel="tag">Filebeat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cgroup/" rel="tag">cgroup</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/" rel="tag">可观测性</a></li></ul></div><div class="post-nav"><a class="pre" href="/2023/04/19/ai-sd-web-ui-build/">本地白嫖AI绘画 ，Stable Diffusion 初探！</a><a class="next" href="/2019/01/03/build-deploy-server-use2/">构建与部署中心使用流程</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
  clientID: 'f9f8d6e8db578e1d4cec',
  clientSecret: 'a26c8b120d01d4d92eb4b69f5b4e9683b1ef9c3d',
  repo: 'struy-cn.github.io',
  owner: 'struy-cn',
  admin: ['StruggleYang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://struy.cn"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img class="nofancybox" src="http://img.struy.cn/img/202209061104733.png"/></a><p>花有重开日，人无再少年</p><a class="info-icon" href="https://space.bilibili.com/243215490" title="bilibili" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:yq1724555319@gmail.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/StruggleYang" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/AIGC/">AIGC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">性能优化</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E4%BA%A7%E5%8A%9B%E5%B7%A5%E5%85%B7/">生产力工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A4%E7%9F%A5%E6%8F%90%E5%8D%87/">认知提升</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/WebGis/" style="font-size: 15px;">WebGis</a> <a href="/tags/DDD/" style="font-size: 15px;">DDD</a> <a href="/tags/%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/" style="font-size: 15px;">领域驱动设计</a> <a href="/tags/EventBus/" style="font-size: 15px;">EventBus</a> <a href="/tags/Dapeng%E5%BE%AE%E6%9C%8D%E5%8A%A1/" style="font-size: 15px;">Dapeng微服务</a> <a href="/tags/AIGC/" style="font-size: 15px;">AIGC</a> <a href="/tags/Stable-Diffusion/" style="font-size: 15px;">Stable Diffusion</a> <a href="/tags/AI%E7%BB%98%E5%9B%BE/" style="font-size: 15px;">AI绘图</a> <a href="/tags/CICD/" style="font-size: 15px;">CICD</a> <a href="/tags/DevOps/" style="font-size: 15px;">DevOps</a> <a href="/tags/%E6%91%98%E5%BD%95/" style="font-size: 15px;">摘录</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Filebeat/" style="font-size: 15px;">Filebeat</a> <a href="/tags/ELK/" style="font-size: 15px;">ELK</a> <a href="/tags/cgroup/" style="font-size: 15px;">cgroup</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7/" style="font-size: 15px;">可观测性</a> <a href="/tags/Github-Copilot/" style="font-size: 15px;">Github Copilot</a> <a href="/tags/AI%E7%BC%96%E7%A0%81/" style="font-size: 15px;">AI编码</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/GithubPages/" style="font-size: 15px;">GithubPages</a> <a href="/tags/Shell/" style="font-size: 15px;">Shell</a> <a href="/tags/Influxdb/" style="font-size: 15px;">Influxdb</a> <a href="/tags/%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">时序数据库</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 15px;">工具</a> <a href="/tags/%E8%AF%BB%E4%B9%A6/" style="font-size: 15px;">读书</a> <a href="/tags/Maven/" style="font-size: 15px;">Maven</a> <a href="/tags/Scala/" style="font-size: 15px;">Scala</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" style="font-size: 15px;">函数式编程</a> <a href="/tags/%E8%A7%82%E7%82%B9/" style="font-size: 15px;">观点</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/%E7%94%B5%E5%BD%B1/" style="font-size: 15px;">电影</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://githubedu.struy.cn/" title="GitHub 学生包认证" target="_blank">GitHub 学生包认证</a><ul></ul><a href="https://hzways.gitee.io/" title="非普通程序员" target="_blank">非普通程序员</a><ul></ul><a href="https://github.red/" title="E99p1ant" target="_blank">E99p1ant</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">老杨的知识荒原.</a><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async="async"></script><div><span id="busuanzi_container_site_pv">本站 <span id="busuanzi_value_site_pv"></span><span> 次访问</span></span><span id="busuanzi_container_site_uv">. <span id="busuanzi_value_site_uv"></span><span> 个访客</span></span></div>Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/love.js?v=1.0.0"></script><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功！"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>